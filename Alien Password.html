<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1">
    <title>Alien Password â€” Keep Talking and Nobody Explodes Module</title>
    <link rel="stylesheet" type="text/css" href="css/font.css" />
    <link rel="stylesheet" type="text/css" href="css/normalize.css" />
    <link rel="stylesheet" type="text/css" href="css/main.css" />
    <script src="js/ktane-utils.js"></script>
    <script src="js/ruleseed.js"></script>
    <script>
        const HALF_SYMBOL_SIZE = 16;
        const SYMBOLS_INTERVAL = 8;
        const LINES_WIDTH = 4;

        // max words count: 256
        // multiplier = 2^(8-log2(words count))
        // left bits = log2(multiplier)
        const TABLE_WIDTH = 4;
        const TABLE_HEIGHT = 8;
        const MULTIPLIER = 8;
        const LEFT_BITS = 3;
        const WORDS_COUNT = TABLE_WIDTH * TABLE_HEIGHT;

        const SVG_NS = "http://www.w3.org/2000/svg";
        const LINES = [
            [0, 0, 1, 0],
            [0, 1, 1, 1],
            [0, 0, 1, 1],
            [1, 0, 0, 1],
            [0, 2, 1, 2],
            [0, 1, 1, 2],
            [1, 1, 0, 2],
        ];
        const PREFIX_LINES = [
            [0, 0, 0, 1],
            [1, 0, 1, 1],
            [0, 1, 0, 2],
        ];
        const POSTFIX_LINES = [
            [1, 0, 1, 1],
            [0, 1, 0, 2],
            [1, 1, 1, 2],
        ];

        /**
         * @param {SVGElement} svg
         * @param {number[]} ids
         * @param {number} scale
         */
        function renderCharacters(svg, ids, scale = 1, italic = 0) {
            svg.setAttribute("fill", "none");
            svg.setAttribute("stroke", "black");
            svg.setAttribute("stroke-width", (LINES_WIDTH * scale).toString(10));
            svg.setAttribute("stroke-linecap", "round");
            svg.setAttribute("stroke-linejoin", "round");
            const sin = Math.sin(italic);
            for (let i = 0; i < ids.length; i++) {
                /** @type {(0 | 1)[]} */
                let bin = [...ids[i].toString(2).padStart(8, "0")].map((c) => c === "0" ? 0 : 1);
                const prevBin = [...bin];
                let counter = 0;
                /** @type {0 | 1} */
                let prevBit = 0;
                for (let j = 0; j < bin.length; j++) {
                    const bit = bin[j];
                    if (bit !== prevBit) [prevBit, counter] = [bit, 1];
                    else if (counter >= 2 && j < bin.length - 1) {
                        /** @type {0 | 1} */
                        const negBit = (bit + 1) % 2;
                        bin = [...bin.slice(0, j + 1), negBit, ...bin.slice(j + 1)];
                        counter = -1;
                        prevBit = negBit;
                    } else counter += 1;
                    if (!bit) continue;
                    const line = j < LINES.length ? LINES[j] : (i % 2 === 0 ? PREFIX_LINES : POSTFIX_LINES)[j - LINES.length];
                    const offset = LINES_WIDTH + i * HALF_SYMBOL_SIZE + Math.floor(i / 2) * SYMBOLS_INTERVAL;
                    const lineSvg = svg.appendChild(document.createElementNS(SVG_NS, "line"));
                    lineSvg.setAttribute("x1", scale * (offset + line[0] * HALF_SYMBOL_SIZE + sin * HALF_SYMBOL_SIZE * (2 - line[1])));
                    lineSvg.setAttribute("y1", scale * (LINES_WIDTH + line[1] * HALF_SYMBOL_SIZE));
                    lineSvg.setAttribute("x2", scale * (offset + line[2] * HALF_SYMBOL_SIZE + sin * HALF_SYMBOL_SIZE * (2 - line[3])));
                    lineSvg.setAttribute("y2", scale * (LINES_WIDTH + line[3] * HALF_SYMBOL_SIZE));
                    lineSvg.setAttribute("stroke", "black");
                }
                // console.log(prevBin.join(""), bin.join(""));
            }
        }

        function rndBitWeighted(rnd) {
            if (rnd.nextMax(3) === 0) return 1;
            return 0;
        }

        function rndMultiBitsWeighted(rnd, bits = 8) {
            let result = 0;
            for (let i = 0; i < bits; i++) result = result * 2 + rndBitWeighted(rnd);
            return result;
        }

        function shuffled(arr) {
            const res = [...arr];
            for (let i = 0; i < res.length; i++) {
                const j = Math.floor(Math.random() * res.length);
                [res[i], res[j]] = [res[j], res[i]];
            }
            return res;
        }

        function setDefaultRules(rnd) { setRules(rnd); }
        function setRules(rnd) {
            /** @type {number[][]} */
            let words = [];
            for (let i = 0; i < WORDS_COUNT; i++) {
                const firstCharId = i * MULTIPLIER + rnd.nextMax(MULTIPLIER);
                // const firstCharId = i * MULTIPLIER + rndMultiBitsWeighted(rnd, LEFT_BITS);
                words.push([firstCharId, ...new Array(5).fill(0).map(() => rnd.nextMax(256))]);
                // words.push([firstCharId, ...new Array(5).fill(0).map(() => rndMultiBitsWeighted(rnd))]);
            }
            // words = rnd.shuffleArray(words);
            words = shuffled(words);
            console.log(words.map((word) => `[${word.map((i) => i.toString(10).padStart(3, " ")).join(",")}]`).join("\n"));

            const table = document.getElementById("table");
            for (let y = 0; y < TABLE_HEIGHT; y++) {
                const tr = table.appendChild(document.createElement("tr"));
                for (let x = 0; x < TABLE_WIDTH; x++) {
                    const td = tr.appendChild(document.createElement("td"));
                    const wordIndex = y * TABLE_WIDTH + x;
                    const svg = td.appendChild(document.createElementNS(SVG_NS, "svg"));
                    svg.setAttribute("width", "120");
                    svg.setAttribute("height", "40");
                    renderCharacters(svg, words[wordIndex]);
                }
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            renderCharacters(document.getElementById("svg-aaaaaa"), [0, 0, 0, 0, 0, 0], 0.375, 0.13);
            renderCharacters(document.getElementById("svg-aaaaac"), [0, 0, 0, 0, 0, 2], 0.375, 0.13);
            renderCharacters(document.getElementById("svg-aaaaab"), [0, 0, 0, 0, 0, 1], 0.375, 0.13);
            renderCharacters(document.getElementById("svg-aaaaaa-1"), [0, 0, 0, 0, 0, 0], 0.375, 0.13);
            renderCharacters(document.getElementById("svg-submit"), [18, 20, 1, 12, 8, 19], 0.5);
        });
    </script>
    <style>
        svg {
            vertical-align: middle;
            display: inline-block;
        }

        span {
            display: inline-block;
        }

        table {
            margin: auto;
        }

        .flavour-text {
            display: flex;
            align-items: center;
        }
    </style>
</head>

<body>
    <div class="section">
        <div class="page page-bg-07">
            <div class="page-header">
                <span class="page-header-doc-title">Keep Talking and Nobody Explodes Mod</span>
                <span class="page-header-section-title">Alien Password</span>
            </div>
            <div class="page-content">
                <img src="img/Component/Module Name.svg" width="144" height="144" class="diagram">
                <h2>On the Subject of Alien Password</h2>
                <p class="flavour-text">
                    <svg id="svg-aaaaaa" width="47" height="15"></svg>
                    . No?&nbsp;
                    <svg id="svg-aaaaac" width="47" height="15"></svg>
                    . Wait, did we do "
                    <svg id="svg-aaaaab" width="47" height="15"></svg>
                    "? *sigh*&nbsp;
                    <svg id="svg-aaaaaa-1" width="47" height="15"></svg>
                    ...
                </p>
                <ul>
                    <li>The buttons above and below each letter will cycle through the possibilities for that position.</li>
                    <li>Only one combination of the available letters will match a password below.</li>
                    <li>Press the submit button once the correct word has been set.</li>
                    <li>Submit button is <svg id="svg-submit" width="60" height="20"></svg>.</li>
                </ul>
                <table>
                    <tbody id="table"></tbody>
                </table>
            </div>
            <div class="page-footer relative-footer">Page 1 of 1</div>
        </div>
    </div>
</body>

</html>
